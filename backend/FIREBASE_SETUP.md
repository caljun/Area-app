# Firebase Cloud Messaging (FCM) ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Area Appã«Firebase Cloud Messagingï¼ˆFCMï¼‰ã‚’çµ±åˆã—ã€Pushé€šçŸ¥ã‚’é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ“‹ å‰ææ¡ä»¶

- Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆæ¸ˆã¿ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: `area-90c52`ï¼‰
- iOSå´ã§ `GoogleService-Info.plist` ãŒè¨­å®šæ¸ˆã¿
- Node.js ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒç¨¼åƒä¸­

---

## ğŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. Firebase Admin SDK ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã™ã€‚ç¢ºèªã™ã‚‹ã«ã¯ï¼š

```bash
cd backend
npm list firebase-admin
```

### 2. Firebase ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã®å–å¾—

1. [Firebase Console](https://console.firebase.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ `area-90c52` ã‚’é¸æŠ
3. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã€âš™ï¸ ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ã‚¿ãƒ–ã‚’é¸æŠ
5. ã€Œæ–°ã—ã„ç§˜å¯†éµã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
6. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `backend/firebase-service-account.json` ã¨ã—ã¦ä¿å­˜

**âš ï¸ é‡è¦**: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚€ãŸã‚ã€Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ã€‚

### 3. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

`backend/.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼š

```env
# Firebase Admin SDK (Pushé€šçŸ¥)
FIREBASE_SERVICE_ACCOUNT_PATH="./firebase-service-account.json"

# ã¾ãŸã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒï¼ˆRenderãªã©ï¼‰ã®å ´åˆã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã®ã¿æŒ‡å®š
# FIREBASE_PROJECT_ID="area-90c52"
```

æ—¢å­˜ã® `.env` ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€ä¸Šè¨˜ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

### 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èµ·å‹•

```bash
cd backend
npm run dev
```

èµ·å‹•æ™‚ã«ä»¥ä¸‹ã®ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ï¼š

```
âœ… Database connected successfully
âœ… Firebase Admin SDK ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ä½¿ç”¨ï¼‰
```

---

## ğŸ“± iOSå´ã®è¨­å®šï¼ˆæ—¢ã«å®Œäº†ï¼‰

ä»¥ä¸‹ã®è¨­å®šã¯æ—¢ã«å®Ÿè£…æ¸ˆã¿ã§ã™ï¼š

- âœ… Firebase SDK ã®åˆæœŸåŒ–
- âœ… Firebase Messaging ã®çµ±åˆ
- âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®é€ä¿¡
- âœ… Pushé€šçŸ¥å—ä¿¡æ™‚ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†
- âœ… `Info.plist` ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š

---

## ğŸ§ª å‹•ä½œç¢ºèª

### 1. FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ãç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

iOS ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã€Xcodeã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’ç¢ºèªï¼š

```
âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ
ğŸ“± FCMãƒˆãƒ¼ã‚¯ãƒ³: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡ã—ã¾ã—ãŸ
```

### 2. Pushé€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã‚‹ã‹ç¢ºèª

1. ãƒ‡ãƒã‚¤ã‚¹Aã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã€ã‚¨ãƒªã‚¢ã«å‚åŠ 
2. ãƒ‡ãƒã‚¤ã‚¹Bã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã€åŒã˜ã‚¨ãƒªã‚¢ã«å‚åŠ 
3. ãƒ‡ãƒã‚¤ã‚¹Aã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»å‹•
4. ãƒ‡ãƒã‚¤ã‚¹Bã§ä½ç½®ã‚’ç§»å‹•
5. ãƒ‡ãƒã‚¤ã‚¹Aã«Pushé€šçŸ¥ãŒå±Šãã€ä½ç½®æƒ…å ±ãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### 3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã§ç¢ºèª

ãƒ‡ãƒã‚¤ã‚¹BãŒä½ç½®ã‚’æ›´æ–°ã—ãŸæ™‚ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã«ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
ğŸŒ WebSocketé€šçŸ¥é€ä¿¡: 1äººã®å‹é”ã«å€‹åˆ¥é€ä¿¡å®Œäº†
ğŸ“± Pushé€šçŸ¥é€ä¿¡å®Œäº†: 1äººã®å‹é”ã«é€ä¿¡
```

---

## ğŸ”¥ å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´

1. **Firebase Admin SDK ã®åˆæœŸåŒ–**
   - ãƒ•ã‚¡ã‚¤ãƒ«: `src/services/firebaseAdmin.ts`
   - ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦Firebase Admin SDKã‚’åˆæœŸåŒ–

2. **Pushé€šçŸ¥é€ä¿¡æ©Ÿèƒ½**
   - ãƒ•ã‚¡ã‚¤ãƒ«: `src/index.ts`
   - ä½ç½®æƒ…å ±æ›´æ–°æ™‚ã«ã€WebSocketæœªæ¥ç¶šã®å‹é”ã¸Pushé€šçŸ¥ã‚’é€ä¿¡
   - é€šçŸ¥å†…å®¹: ã€Œå‹é”ãŒç§»å‹•ã—ã¾ã—ãŸã€+ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ã‚¨ãƒªã‚¢æƒ…å ±

### iOSå´

1. **Firebase Messaging ã®çµ±åˆ**
   - ãƒ•ã‚¡ã‚¤ãƒ«: `Area/AreaApp.swift`
   - FCMãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®é€ä¿¡

2. **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰Pushé€šçŸ¥å—ä¿¡**
   - ãƒ•ã‚¡ã‚¤ãƒ«: `Area/AreaApp.swift` (`AppDelegate`)
   - Pushé€šçŸ¥ã‚’å—ä¿¡ã™ã‚‹ã¨ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹é”ã®ä½ç½®æƒ…å ±ã‚’è‡ªå‹•åŒæœŸ
   - `action: "friend_moved"` ã®é€šçŸ¥ã‚’å‡¦ç†

3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**
   - ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰: Socket.ioçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
   - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰: FCMçµŒç”±ã§Pushé€šçŸ¥ã‚’å—ä¿¡ã—ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä½ç½®æƒ…å ±ã‚’åŒæœŸ

---

## ğŸš€ ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒï¼ˆRenderï¼‰ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤

Renderãªã©ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã§ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ä»£ã‚ã‚Šã«ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

1. Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
2. JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç’°å¢ƒå¤‰æ•° `FIREBASE_SERVICE_ACCOUNT_JSON` ã«è¨­å®š
3. `src/services/firebaseAdmin.ts` ã§ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã‚€ã‚ˆã†ã«å¤‰æ›´

ã¾ãŸã¯ã€Application Default Credentials ã‚’ä½¿ç”¨ï¼š

```env
FIREBASE_PROJECT_ID="area-90c52"
```

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Pushé€šçŸ¥ãŒå±Šã‹ãªã„

1. **FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª**
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ `deviceToken` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

2. **Firebase Admin SDK ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª**
   - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•æ™‚ã®ãƒ­ã‚°ã‚’ç¢ºèª
   - ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã®ãƒ‘ã‚¹ãŒæ­£ã—ã„ã‹ç¢ºèª

3. **iOSå´ã§é€šçŸ¥æ¨©é™ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª**
   - è¨­å®š > Area > é€šçŸ¥ ãŒã€Œè¨±å¯ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª

4. **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã‹ç¢ºèª**
   - `Info.plist` ã« `remote-notification` ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### Firebase Admin SDK ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼

```
âŒ Firebase Admin SDK ã®åˆæœŸåŒ–ã«å¤±æ•—
```

- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
- ãƒ‘ã‚¹ãŒæ­£ã—ã„ã‹ç¢ºèªï¼ˆ`./firebase-service-account.json`ï¼‰
- JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒæ­£ã—ã„ã‹ç¢ºèª

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Firebase Cloud Messaging - iOS](https://firebase.google.com/docs/cloud-messaging/ios/client)
- [Firebase Admin SDK - Node.js](https://firebase.google.com/docs/admin/setup)
- [iOS Background Modes](https://developer.apple.com/documentation/usernotifications/handling_notifications_and_notification-related_actions)

